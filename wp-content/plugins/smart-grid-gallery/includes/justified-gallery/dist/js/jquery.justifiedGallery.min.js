/*!
 * Justified Gallery - v3.4.0
 * http://miromannino.com/projects/justified-gallery/
 * Copyright (c) 2014 Miro Mannino
 * Licensed under the MIT license.
 */
!function(t){t.fn.justifiedGallery=function(i){function e(t,i,e){var n;return n=t>i?t:i,n<=100?e.settings.sizeRangeSuffixes.lt100:n<=240?e.settings.sizeRangeSuffixes.lt240:n<=320?e.settings.sizeRangeSuffixes.lt320:n<=500?e.settings.sizeRangeSuffixes.lt500:n<=640?e.settings.sizeRangeSuffixes.lt640:e.settings.sizeRangeSuffixes.lt1024}function n(t,i){return-1!==t.indexOf(i,t.length-i.length)}function a(t,i){return t.substring(0,t.length-i.length)}function s(t,i){var e=!1;for(var a in i.settings.sizeRangeSuffixes)if(0!==i.settings.sizeRangeSuffixes[a].length){if(n(t,i.settings.sizeRangeSuffixes[a]))return i.settings.sizeRangeSuffixes[a]}else e=!0;if(e)return"";throw"unknown suffix for "+t}function o(t,i,n,o){var r=t.match(o.settings.extension),g=null!=r?r[0]:"",l=t.replace(o.settings.extension,"");return l=a(l,s(l,o)),l+=e(i,n,o)+g}function r(i){var e=t(i.currentTarget).find(".sgg-caption");i.data.settings.cssAnimation?e.addClass("caption-visible").removeClass("caption-hidden"):e.stop().fadeTo(i.data.settings.captionSettings.animationDuration,i.data.settings.captionSettings.visibleOpacity)}function g(i){var e=t(i.currentTarget).find(".sgg-caption");i.data.settings.cssAnimation?e.removeClass("caption-visible").removeClass("caption-hidden"):e.stop().fadeTo(i.data.settings.captionSettings.animationDuration,i.data.settings.captionSettings.nonVisibleOpacity)}function l(t,i,e){e.settings.cssAnimation?(t.addClass("entry-visible"),i()):t.stop().fadeTo(e.settings.imagesAnimationDuration,1,i)}function d(t,i){i.settings.cssAnimation?t.removeClass("entry-visible"):t.stop().fadeTo(0,0)}function f(i,e,n,a,s,d,f){function u(){c!==p&&h.attr("src",p)}var h=i.find("img");h.css("width",a),h.css("height",s),h.css("margin-left",-a/2),h.css("margin-top",-s/2),i.width(a),i.height(d),i.css("top",n),i.css("left",e);var c=h.attr("src"),p=o(c,a,s,f);h.one("error",function(){h.attr("src",h.data("jg.originalSrc"))}),"skipped"===h.data("jg.loaded")?h.one("load",function(){l(i,u,f),h.data("jg.loaded","loaded")}):l(i,u,f);var m=i.data("jg.captionMouseEvents");if(!0===f.settings.captions){var v=i.find(".sgg-caption");if(0===v.length){var w=h.attr("data-caption");void 0===w&&(w=i.attr("alt")),void 0===w&&(w=i.attr("title")),void 0!==w&&(v=t('<div class="sgg-caption"><span>'+w+"</span></div>"),i.append(v))}0!==v.length&&(f.settings.cssAnimation||v.stop().fadeTo(f.settings.imagesAnimationDuration,f.settings.captionSettings.nonVisibleOpacity),void 0===m&&(m={mouseenter:r,mouseleave:g},i.on("mouseenter",void 0,f,m.mouseenter),i.on("mouseleave",void 0,f,m.mouseleave),i.data("jg.captionMouseEvents",m)))}else void 0!==m&&(i.off("mouseenter",void 0,f,m.mouseenter),i.off("mouseleave",void 0,f,m.mouseleave),i.removeData("jg.captionMouseEvents"))}function u(t,i){var e,n,a,s,o,r,g=t.settings,l=!0,d=0,f=t.galleryWidth-(t.buildingRow.entriesBuff.length-1)*g.margins,u=f/t.buildingRow.aspectRatio,h=t.buildingRow.width/f>g.justifyThreshold;if(i&&"hide"===g.lastRow&&!h){for(e=0;e<t.buildingRow.entriesBuff.length;e++)n=t.buildingRow.entriesBuff[e],g.cssAnimation?n.removeClass("entry-visible"):n.stop().fadeTo(0,0);return-1}for(i&&!h&&"nojustify"===g.lastRow&&(l=!1),e=0;e<t.buildingRow.entriesBuff.length;e++)s=(a=t.buildingRow.entriesBuff[e].find("img")).data("jg.imgw")/a.data("jg.imgh"),l?(o=u*s,r=u):(o=g.rowHeight*s,r=g.rowHeight),a.data("jg.jimgw",Math.ceil(o)),a.data("jg.jimgh",Math.ceil(r)),(0===e||d>r)&&(d=r);return g.fixedHeight&&d>g.rowHeight&&(d=g.rowHeight),{minHeight:d,justify:l}}function h(t){t.lastAnalyzedIndex=-1,t.buildingRow.entriesBuff=[],t.buildingRow.aspectRatio=0,t.buildingRow.width=0,t.offY=0}function c(t,i){var e,n,a,s,o=t.settings,r=0;if(s=u(t,i),a=s.minHeight,i&&"hide"===o.lastRow&&-1===a)return t.buildingRow.entriesBuff=[],t.buildingRow.aspectRatio=0,void(t.buildingRow.width=0);o.maxRowHeight>0&&o.maxRowHeight<a?a=o.maxRowHeight:0===o.maxRowHeight&&1.5*o.rowHeight<a&&(a=1.5*o.rowHeight);for(var g=0;g<t.buildingRow.entriesBuff.length;g++)n=(e=t.buildingRow.entriesBuff[g]).find("img"),f(e,r,t.offY,n.data("jg.jimgw"),n.data("jg.jimgh"),a,t),r+=n.data("jg.jimgw")+o.margins;t.$gallery.height(t.offY+a+(t.spinner.active?t.spinner.$el.innerHeight():0)),(!i||a<=t.settings.rowHeight&&s.justify)&&(t.offY+=a+t.settings.margins,t.buildingRow.entriesBuff=[],t.buildingRow.aspectRatio=0,t.buildingRow.width=0,t.$gallery.trigger("jg.rowflush"))}function p(t){t.checkWidthIntervalId=setInterval(function(){var i=parseInt(t.$gallery.width(),10);t.galleryWidth!==i&&(t.galleryWidth=i,h(t),b(t,!0))},t.settings.refreshTime)}function m(t){clearInterval(t.intervalId),t.intervalId=setInterval(function(){t.phase<t.$points.length?t.$points.eq(t.phase).fadeTo(t.timeslot,1):t.$points.eq(t.phase-t.$points.length).fadeTo(t.timeslot,0),t.phase=(t.phase+1)%(2*t.$points.length)},t.timeslot)}function v(t){clearInterval(t.intervalId),t.intervalId=null}function w(t){t.yield.flushed=0,null!==t.imgAnalyzerTimeout&&clearTimeout(t.imgAnalyzerTimeout)}function b(t,i){w(t),t.imgAnalyzerTimeout=setTimeout(function(){y(t,i)},.001),y(t,i)}function y(i,e){for(var n,a=i.settings,s=i.lastAnalyzedIndex+1;s<i.entries.length;s++){var o=t(i.entries[s]),r=o.find("img");if(!0===r.data("jg.loaded")||"skipped"===r.data("jg.loaded")){n=s>=i.entries.length-1;var g=i.galleryWidth-(i.buildingRow.entriesBuff.length-1)*a.margins,l=r.data("jg.imgw")/r.data("jg.imgh");if(g/(i.buildingRow.aspectRatio+l)<a.rowHeight&&(c(i,n),++i.yield.flushed>=i.yield.every))return void b(i,e);i.buildingRow.entriesBuff.push(o),i.buildingRow.aspectRatio+=l,i.buildingRow.width+=l*a.rowHeight,i.lastAnalyzedIndex=s}else if("error"!==r.data("jg.loaded"))return}i.buildingRow.entriesBuff.length>0&&c(i,!0),i.spinner.active&&(i.spinner.active=!1,i.$gallery.height(i.$gallery.height()-i.spinner.$el.innerHeight()),i.spinner.$el.detach(),v(i.spinner)),w(i),e?i.$gallery.trigger("jg.resize"):i.$gallery.trigger("jg.complete")}function R(t){function i(t){if("string"!=typeof n.sizeRangeSuffixes[t])throw"sizeRangeSuffixes."+t+" must be a string"}function e(t,i){if("string"==typeof t[i]){if(t[i]=parseFloat(t[i],10),isNaN(t[i]))throw"invalid number for "+i}else{if("number"!=typeof t[i])throw i+" must be a number";if(isNaN(t[i]))throw"invalid number for "+i}}var n=t.settings;if("object"!=typeof n.sizeRangeSuffixes)throw"sizeRangeSuffixes must be defined and must be an object";if(i("lt100"),i("lt240"),i("lt320"),i("lt500"),i("lt640"),i("lt1024"),e(n,"rowHeight"),e(n,"maxRowHeight"),n.maxRowHeight>0&&n.maxRowHeight<n.rowHeight&&(n.maxRowHeight=n.rowHeight),e(n,"margins"),"nojustify"!==n.lastRow&&"justify"!==n.lastRow&&"hide"!==n.lastRow)throw'lastRow must be "nojustify", "justify" or "hide"';if(e(n,"justifyThreshold"),n.justifyThreshold<0||n.justifyThreshold>1)throw"justifyThreshold must be in the interval [0,1]";if("boolean"!=typeof n.cssAnimation)throw"cssAnimation must be a boolean";if(e(n.captionSettings,"animationDuration"),e(n,"imagesAnimationDuration"),e(n.captionSettings,"visibleOpacity"),n.captionSettings.visibleOpacity<0||n.captionSettings.visibleOpacity>1)throw"captionSettings.visibleOpacity must be in the interval [0, 1]";if(e(n.captionSettings,"nonVisibleOpacity"),n.captionSettings.visibleOpacity<0||n.captionSettings.visibleOpacity>1)throw"captionSettings.nonVisibleOpacity must be in the interval [0, 1]";if("boolean"!=typeof n.fixedHeight)throw"fixedHeight must be a boolean";if("boolean"!=typeof n.captions)throw"captions must be a boolean";if(e(n,"refreshTime"),"boolean"!=typeof n.randomize)throw"randomize must be a boolean"}var j={sizeRangeSuffixes:{lt100:"_t",lt240:"_m",lt320:"_n",lt500:"",lt640:"_z",lt1024:"_b"},rowHeight:120,maxRowHeight:0,margins:1,lastRow:"nojustify",justifyThreshold:.75,fixedHeight:!1,waitThumbnailsLoad:!0,captions:!0,cssAnimation:!1,imagesAnimationDuration:500,captionSettings:{animationDuration:500,visibleOpacity:.7,nonVisibleOpacity:0},rel:null,target:null,extension:/\.[^.\\/]+$/,refreshTime:100,randomize:!1};return this.each(function(e,n){var a=t(n);a.addClass("justified-gallery");var s=a.data("jg.context");if(void 0===s){if(void 0!==i&&null!==i&&"object"!=typeof i)throw"The argument must be an object";var o=t('<div class="spinner"><span></span><span></span><span></span></div>');s={settings:t.extend({},j,i),imgAnalyzerTimeout:null,entries:null,buildingRow:{entriesBuff:[],width:0,aspectRatio:0},lastAnalyzedIndex:-1,yield:{every:2,flushed:0},offY:0,spinner:{active:!1,phase:0,timeslot:150,$el:o,$points:o.find("span"),intervalId:null},checkWidthIntervalId:null,galleryWidth:a.width(),$gallery:a},a.data("jg.context",s)}else if("norewind"===i)for(var r=0;r<s.buildingRow.entriesBuff.length;r++)d(s.buildingRow.entriesBuff[r],s);else s.settings=t.extend({},s.settings,i),h(s);if(R(s),s.entries=a.find("> a, > div:not(.spinner)").toArray(),0!==s.entries.length){s.settings.randomize&&(s.entries.sort(function(){return 2*Math.random()-1}),t.each(s.entries,function(){t(this).appendTo(a)}));var g=!1;t.each(s.entries,function(i,e){var n=t(e),o=n.find("img");if(!0!==o.data("jg.loaded")&&"skipped"!==o.data("jg.loaded")){null!==s.settings.rel&&n.attr("rel",s.settings.rel),null!==s.settings.target&&n.attr("target",s.settings.target);var r=void 0!==o.data("safe-src")?o.data("safe-src"):o.attr("src");o.data("jg.originalSrc",r),o.attr("src",r);var l=parseInt(o.attr("width"),10),d=parseInt(o.attr("height"),10);if(!0!==s.settings.waitThumbnailsLoad&&!isNaN(l)&&!isNaN(d))return o.data("jg.imgw",l),o.data("jg.imgh",d),o.data("jg.loaded","skipped"),b(s,!1),!0;o.data("jg.loaded",!1),g=!0,!1===s.spinner.active&&(s.spinner.active=!0,a.append(s.spinner.$el),a.height(s.offY+s.spinner.$el.innerHeight()),m(s.spinner));var f=new Image,u=t(f);u.one("load",function(){o.off("load error"),o.data("jg.imgw",f.width),o.data("jg.imgh",f.height),o.data("jg.loaded",!0),b(s,!1)}),u.one("error",function(){o.off("load error"),o.data("jg.loaded","error"),b(s,!1)}),f.src=r}}),g||b(s,!1),p(s)}})}}(jQuery);